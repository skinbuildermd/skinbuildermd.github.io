<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://baguettecss.github.io/v1/v1.css">
    <link rel="shortcut icon" href="./img/logo/logo-spwp.svg" type="image/x-icon">

    <title>SkinBuilder</title>
</head>
<body>
    <div class="headline -l">
        <div class="logo">
            <a href="./">
                <img src="./img/logo/logo-spwp1.svg" alt="">
            </a>
        </div>
    </div>
    <div class="main">
        <div class="in">
            <div class="pre-skin">
                <div class="adds-skins -br">
                    <div id="golova" class="installed"></div>
                    <div id="verh" class="installed"></div>                    
                    <div id="nogi" class="installed"></div>
                    <div id="obuv" class="installed"></div>
                </div>
            </div>
            <div class="skin -br">
                <div class="pix-skin">
                    <img id="skin-sel" src="img/air.png" alt="">
                </div>
                <div class="skompil">
                    <label class="change-btn -br" for="inputImage">
                        <span id="labelText" title="Выберите файл...">Выберите файл</span>
                        <input type="file" id="inputImage" accept="image/*">
                    </label>
                    <div style="margin-left: 1rem;" class="skompil-btn -br">
                        <p id="compileButton" title="Скомпилировать Ваш скин" onclick="compileSkin()">Скомпилировать</p>
                    </div>
                </div>
            </div>
            <div class="at">
                <div class="clothes -br">
                    <div class="c hj"></div>
                    <div class="c verh selected" onclick="changeClothes('verh')"><img class="verh" src="./img/models/verh/verh_1.png"></div>
                    <div class="c nogi" id="nogi-add" onclick="changeClothes('nogi')"><img src="./img/models/nogi/nogi_1.png"></div>
                    <div class="c obuv" onclick="changeClothes('obuv')"></div>
                </div>
                <div class="all-cloat -br">
                    <div class="all-cloat-scroll">
                        <div class="w">
                            <img id="verh-go" src="./img/models/verh/verh_1.png" alt="">
                        </div>
                        <div class="w">
                            <img id="verh-go" src="./img/models/verh/verh_2.png" alt="">
                        </div>
                        <div class="w">
                            <img id="verh-go" src="./img/models/verh/verh_3.png" alt="">
                        </div>                        
                    </div>
            </div>
        </div>
    </div>
    <script>
        function displaySelectedFile(event) {
            var file = event.target.files[0];
            var reader = new FileReader();

            reader.onload = function(event) {
                var image = document.getElementById("skin-sel");
                image.setAttribute('src', event.target.result);
            };

            reader.readAsDataURL(file);
        }
        
        
        function changeClothes(clothesType) {
            var images = document.querySelectorAll('.w img');
            var selectedNogi = document.querySelector('.nogi.selected');
            var nogiElement = document.getElementById('nogi');
            var wElements = document.querySelectorAll('.w');
          
            if (clothesType === 'nogi') {
              images.forEach(function (image) {
                var src = image.getAttribute('src');
                var newSrc = src.replace('/verh/', '/nogi/').replace('verh_', 'nogi_');
                image.src = newSrc;
                image.id = 'nogi-go';
              });
          
              if (selectedNogi) {
                if (selectedNogi.classList.contains('selected')) {
                  selectedNogi.innerHTML = '<img class="nogi" src="' + wElements[0].querySelector('img').getAttribute('src') + '">';
                }
              }
          
              wElements.forEach(function (wElement) {
                var image = wElement.querySelector('img');
                if (image && image.getAttribute('id') === 'verh-go') {
                  image.removeAttribute('id');
                }
              });
            } else if (clothesType === 'verh') {
              images.forEach(function (image) {
                var src = image.getAttribute('src');
                var newSrc = src.replace('/nogi/', '/verh/').replace('nogi_', 'verh_');
                image.src = newSrc;
                image.removeAttribute('id');
              });
          
              wElements.forEach(function (wElement) {
                var image = wElement.querySelector('img');
                if (image && image.getAttribute('id') !== 'verh-go') {
                  image.id = 'verh-go';
                }
              });
            }
          }                                     
        
        var verhGoElements = document.querySelectorAll(".w img[id^='verh-go']");

// Получаем все элементы с классом "verh-go"
var verhGoElements = document.querySelectorAll("[id^='verh-go']");

// Добавляем обработчик событий к каждому элементу
verhGoElements.forEach(function (element) {
    element.addEventListener("click", function () {
      var imageUrl = this.src;
      var image = document.createElement("img");
      image.src = imageUrl;
      image.alt = "Image";
  
      if (this.id === "nogi-go") {
        var divNogi = document.getElementById("nogi");
        divNogi.innerHTML = ""; // Очищаем содержимое блока "nogi"
        divNogi.appendChild(image);
      } else {
        var divInstalled = document.createElement("div");
        divInstalled.classList.add("installed");
        divInstalled.id = "verh";
        divInstalled.innerHTML = '<img id="verh-skin" src="' + imageUrl + '">';
  
        var existingDivVerh = document.getElementById("verh");
        existingDivVerh.parentNode.replaceChild(divInstalled, existingDivVerh);
      }
    });
  });

  function compileSkin() {
    var selectedFile = document.getElementById('inputImage').files[0];
    var clothesElement = document.getElementById('verh');
    var clothesImage = clothesElement.querySelector('img');
    var clothesSrc = clothesImage.getAttribute('src');
  
    if (clothesElement.id !== 'nogi') {
      // Продолжить только если выбран верхний элемент (не штаны)
      var canvas = document.createElement('canvas');
      var ctx = canvas.getContext('2d');
      var img = new Image();
  
      img.onload = function () {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
  
        var installedImage = document.querySelector('#verh.installed img');
        if (installedImage) {
          var imageSrc = installedImage.src.replace('models', 'skins');
          var fileName = imageSrc.split('/').pop();
          clothesSrc = './img/skins/verh/' + fileName;
  
          var skinImage = new Image();
          skinImage.onload = function () {
            ctx.drawImage(skinImage, 0, 0, img.width, img.height);
            var nogiGoImage = document.getElementById('nogi-go');
  
            if (nogiGoImage) {
              var nogiImg = new Image();
              nogiImg.onload = function () {
                ctx.drawImage(nogiImg, 0, 0, img.width, img.height);
  
                var downloadLink = document.createElement('a');
                downloadLink.href = canvas.toDataURL();
                downloadLink.download = 'compiled_skin.png';
                downloadLink.click();
              };
              var nogiSrc = nogiGoImage.src.replace('models', 'skins');
              nogiImg.src = nogiSrc;
            } else {
              var downloadLink = document.createElement('a');
              downloadLink.href = canvas.toDataURL();
              downloadLink.download = 'compiled_skin.png';
              downloadLink.click();
            }
          };
          skinImage.src = clothesSrc;
        } else {
          var clothesImg = new Image();
          clothesImg.onload = function () {
            ctx.drawImage(clothesImg, 0, 0, img.width, img.height);
  
            var skinImage = document.getElementById('skin-sel');
            var skinSrc = skinImage.getAttribute('src');
            var skinImg = new Image();
            skinImg.onload = function () {
              ctx.drawImage(skinImg, 0, 0, img.width, img.height);
              var nogiGoImage = document.getElementById('nogi-go');
  
              if (nogiGoImage) {
                var nogiImg = new Image();
                nogiImg.onload = function () {
                  ctx.drawImage(nogiImg, 0, 0, img.width, img.height);
  
                  var downloadLink = document.createElement('a');
                  downloadLink.href = canvas.toDataURL();
                  downloadLink.download = 'compiled_skin.png';
                  downloadLink.click();
                };
                var nogiSrc = nogiGoImage.src.replace('models', 'skins');
                nogiImg.src = nogiSrc;
              } else {
                var downloadLink = document.createElement('a');
                downloadLink.href = canvas.toDataURL();
                downloadLink.download = 'compiled_skin.png';
                downloadLink.click();
              }
            };
            skinImg.src = skinSrc;
          };
          clothesImg.src = clothesSrc;
        }
      };
      img.src = URL.createObjectURL(selectedFile);
    }
  }  

        document.getElementById('inputImage').addEventListener('change', displaySelectedFile);


        document.addEventListener('DOMContentLoaded', function() {
            var nogiGoImages = document.querySelectorAll('#nogi-go');
          
            nogiGoImages.forEach(function(image) {
              image.addEventListener('click', function() {
                var nogiElement = document.getElementById('nogi');
                nogiElement.innerHTML = '<img class="nogi" src="' + this.src + '">';
              });
            });
          });          


        //Переключение между категориями
        document.addEventListener('DOMContentLoaded', function() {
            var nogiElement = document.querySelector('.nogi');
            var verhElement = document.querySelector('.verh');
        
            nogiElement.addEventListener('click', function() {
                nogiElement.classList.add('selected');
                verhElement.classList.remove('selected');
            });
        
            verhElement.addEventListener('click', function() {
                verhElement.classList.add('selected');
                nogiElement.classList.remove('selected');
            });
        });
    </script>
</body>
</html>